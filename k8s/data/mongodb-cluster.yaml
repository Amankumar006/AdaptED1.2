---
# Secret is now managed in k8s/secrets/database-secrets.yaml
# Do not commit actual credentials - use external secret management
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb-primary
  namespace: educational-platform-data
spec:
  serviceName: mongodb-primary
  replicas: 1
  selector:
    matchLabels:
      app: mongodb-primary
  template:
    metadata:
      labels:
        app: mongodb-primary
        role: primary
    spec:
      containers:
      - name: mongodb
        image: mongo:7.0
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: admin
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-credentials
              key: mongodb-root-password
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-storage
          mountPath: /data/db
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
        command:
        - mongod
        - --replSet
        - rs0
        - --bind_ip_all
  volumeClaimTemplates:
  - metadata:
      name: mongodb-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-primary
  namespace: educational-platform-data
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: mongodb-primary
  ports:
  - port: 27017
    targetPort: 27017
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb-secondary
  namespace: educational-platform-data
spec:
  serviceName: mongodb-secondary
  replicas: 2
  selector:
    matchLabels:
      app: mongodb-secondary
  template:
    metadata:
      labels:
        app: mongodb-secondary
        role: secondary
    spec:
      containers:
      - name: mongodb
        image: mongo:7.0
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: admin
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-credentials
              key: mongodb-root-password
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongodb-storage
          mountPath: /data/db
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
        command:
        - mongod
        - --replSet
        - rs0
        - --bind_ip_all
  volumeClaimTemplates:
  - metadata:
      name: mongodb-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-secondary
  namespace: educational-platform-data
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: mongodb-secondary
  ports:
  - port: 27017
    targetPort: 27017
---
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-replica-init
  namespace: educational-platform-data
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-primary
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for mongodb-primary-0 to be ready..."
          until nc -z mongodb-primary-0.mongodb-primary 27017; do
            echo "Primary not ready yet, waiting..."
            sleep 5
          done
          echo "Primary is ready!"
      containers:
      - name: mongodb-init
        image: mongo:7.0
        env:
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-credentials
              key: mongodb-root-password
        command:
        - bash
        - -c
        - |
          echo "Sleeping to allow all pods to come up..."
          sleep 60
          echo "Initializing replica set..."
          mongosh --host mongodb-primary-0.mongodb-primary:27017 \
            -u admin \
            -p "$MONGO_INITDB_ROOT_PASSWORD" \
            --authenticationDatabase admin \
            --eval "
            rs.initiate({
              _id: 'rs0',
              members: [
                { _id: 0, host: 'mongodb-primary-0.mongodb-primary:27017', priority: 2 },
                { _id: 1, host: 'mongodb-secondary-0.mongodb-secondary:27017', priority: 1 },
                { _id: 2, host: 'mongodb-secondary-1.mongodb-secondary:27017', priority: 1 }
              ]
            })"
          echo "Replica set initialization complete!"
      restartPolicy: OnFailure